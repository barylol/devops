## Ansible

1. Объясните концепцию Infrastructure as Code, зачем это нужно и какие проблемы решает?

  <details>
    <summary>Ответ</summary>

  Инфраструктура как код (англ. Infrastructure as Code; Iac) это подход для управления и описания инфраструктуры ЦОД через конфигурационные файлы, а не через ручное редактирование конфигураций на серверах или интерактивное взаимодействие. Этот подход может включать в себя как декларативный способ описания инфраструктуры, так и императивный. Ценность IaC заключается в уменьшении расходов, увеличения скорости выполнения операций и уменьшение рисков в случае ошибок. Уменьшение расходов относится не только к финансовой составляющей, но и к количеству времени, затрачиваемого на рутинные операции. Принципы IaC позволяют не фокусироваться на рутине, а заниматься более важными задачами. Автоматизация инфраструктуры позволяет эффективнее использовать существующие ресурсы. Также автоматизация позволяет минимизировать риск возникновения человеческой ошибки. Всё это является частью культуры DevOps

  </details>

---

2. Чем отличаются Ansible модули *raw*, *command* и *shell*?

  <details>
    <summary>Ответ</summary>

  Модуль *raw* отличается от *command* и *shell* тем, что не выполняет дополнительную обработку выполнения команды. Эти дополнительные обработки присутствуют в почти любом модуле Ansible. Модуль *raw* передает команду, как есть, в "сыром" (raw) виде без проверок.
  Модули *command* и *shell* отличаются тем, что в модуле *command* команда выполняется без прохождения через командную оболочку `/bin/sh`. Поэтому переменные определенные в оболочке и перенаправления - конвееры работать не будут. Модуль *shell* выполняет команды через оболочку по умолчанию `/bin/sh`. Поэтому там будут доступны переменные оболочки и перенаправления.

  </details>

---

3. На всех серверах должен быть набор пользователей, с доступом по ssh-ключу, стандартный модуль user не позволяет вносить ssh ключ в authorized_keys. Предложите решение.

  <details>
    <summary>Ответ</summary>

  1. Использовать модуль `authorized_key` для добавления ключей.
  2. Использовать модуль `shell`, чтобы вручную с использованием команды `cat {{ PUBLIC_SSH_KEY }} >> /home/{{ USER }}/.ssh/authorized_keys` добавить ключ. В данном случае шаблоны Jinja2 PUBLIC_SSH_KEY и USER должны быть заданы.

  </details>

---

4. Есть группы пользователей, которые должны заводиться не на всех серверах. Как ограничить заведение пользователей?

  <details>
    <summary>Ответ</summary>

  Сгруппировать сервера, на которых должны заводиться группы пользователей, в инвентори или написать в плейбуке условие, которому передаётся список серверов, на которых необходимо выполнить задачу.

  </details>

---

5. На новом сервере не установлен Python, который требуется для работы Ansible. Как выполнить установку Python на сервере используя Ansible?

  <details>
    <summary>Ответ</summary>

  Использовать модуль `raw`, которому необходимо передать команду для установки python на сервере. Модуль `raw` принимает команду без дополнительной обработки Python и выполняет её на сервере.

  </details>

---

6. Что такое роль в Ansible? Что содержит в себе Ansible роль?

  <details>
    <summary>Ответ</summary>

  Ansible роль представляет собой структурированный плейбук, содержащий, как минимум, набор задач (tasks) и дополнительно - обработчики событий (handlers), переменных (default и vars), файлов (files), шаблонов (templates), описание и зависимости (metadata) и тесты (tests).

  </details>

---

7. Что такое обработчик событий? Как его вызвать?

  <details>
    <summary>Ответ</summary>

  Обработчик событий (handler) это последовательность команд, вызываемая в ответ на какие-то события. Поставить обработчик событий можно при помощи оператора notify.
  Пример использования обработчика - рестарт nginx при обновлении конфигурации. Если в плейбуке есть шаг с копированием конфигурации nginx и обработчик, перезапускающий nginx, то при добавлении notify в шаг с копированием конфигурации обработчик будет вызван только в случае изменения конфигурации. При отсутствии изменений перезапуск nginx не будет выполнен.

  </details>

---

8. В Ansible роли есть директории *vars* и *defaults*. Что они содержат и чем отличаются?

  <details>
    <summary>Ответ</summary>

  Ansible применяет порядок приоритета переменных. Ниже представлен список в порядке повышения приоритета.

  1. command line values (for example, -u my_user, these are not variables)
  2. role defaults (defined in role/defaults/main.yml)
  3. inventory file or script group vars
  4. inventory group_vars/all
  5. playbook group_vars/all
  6. inventory group_vars/*
  7. playbook group_vars/*
  8. inventory file or script host vars
  9. inventory host_vars/*
  10. playbook host_vars/*
  11. host facts / cached set_facts
  12. play vars
  13. play vars_prompt
  14. play vars_files
  15. role vars (определяемые в role/vars/main.yml)
  16. block vars (только для задач в `block`)
  17. task vars (только для задач)
  18. include_vars
  19. set_facts / registered vars
  20. role (и include_role) params
  21. include params
  22. extra vars (например, -e "user=my_user")(всегда приоритетнее)

  Соответственно переменные в *vars* будут приорететнее, чем в *defaults*.

  </details>

---

9. В Ansible роли есть директории *files* и *templates*. Что они содержат и чем отличаются?

  <details>
    <summary>Ответ</summary>

  *files* - содержит файлы, которые будут скопированы на настраиваемые хосты; так же — может содержать скрипты, которые позже будут запускаться на хостах

  *templates* - содержит шаблоны файлов с переменными

  </details>

---

10. По умолчанию, в Ansible все задачи из списка выполняются параллельно на всех хостах, которые указаны в `hosts`. Как сделать так, чтобы задачи выполнялись последовательно по хостам?

  <details>
    <summary>Ответ</summary>

  Необходимо установить параметр `serial: 1`, чтобы определить количество хостов, на которых будут выполняться паралелльно задачи. Значение 1 будет значить, что все задачи будут проходить параллельно по 1 хосту за раз.

  Ссылка на документацию: https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html#setting-the-batch-size-with-serial

  </details>

---

11. Как можно протестировать плейбук Ansible?

  <details>
    <summary>Ответ</summary>

  * ansible-lint - линтер, проверяющий соответствие плейбука лучшим практикам
  * Molecule - фреймворк, запускающий плейбук либо на Docker-контейнере, либо на виртуалке, поднятой при помощи Vagrant. Molecule позволяет провести тест плейбука на идемпотентность, а также верифицировать успешность выполнения действий, описанных в плейбуке.

  </details>

---

12. Что такое идемпотентсноть?

  <details>
    <summary>Ответ</summary>

  Идемпоте́нтность (лат. idem — тот же самый + potens — способный) - свойство объекта или операции при повторном применении операции к объекту давать тот же результат, что и при первом применении. В контексте Ansible идемпотентность плейбука это свойство, при котором первый запуск плейбука приводит систему в желаемое состояние, а при повторном запуске вносит изменения только в том случае, если это необходимо. То есть, плейбук идемпотентен если на каждый его запуск можно получить один и тот же конкретный и ожидаемый результат. Пример идемпотентного плейбука - плейбук, управляющий конфигурацией nginx через шаблоны. Если в шаблон не вносились изменения, то при выполнении плейбука он не будет выполняться и шаг копирования конфига закончится с результатом OK. Если же в шаблон будут внесены изменения, то при выполнении плейбука конфиг обновится, а шаг копирования конфига закончится с результатом Changed

  </details>

---

13. В чём отличие между модулем и плагином?

  <details>
    <summary>Ответ</summary>

  Код из модуля выполняется на стороне целевого хоста, код из плагина выполняется на стороне хоста, где запущен Ansible.

  </details>

---

14. Для чего нужен Ad-Hoc в Ansible?

<details>
  <summary>Ответ</summary>

  Ad-Hoc это режим работы Ansible, когда запрос к серверу выполняется напрямую из командной строки, без создания дополнительных файлов.

</details>
